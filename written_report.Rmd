---
title: "P8130 Final Project: Predicting Breast Cancer Survival"
author: "Guadalupe Antonio Lopez, Gustavo Garcia-Franceschini, Derek Lamb"
header-includes:
    - \usepackage{setspace}\doublespacing

output: pdf_document
---

```{r load packages and default options, include = FALSE}
# Load packages
library(separationplot)
library(tidyverse)
library(broom)
library(knitr)
library(modelr)
library(pROC)

# Set default figure options
knitr::opts_chunk$set(
  fig.width = 6,
  out.width = "90%"
)

theme_set(theme_bw() + theme(legend.position = "bottom"))

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```

## Abstract

## Introduction

Background info/research on breast cancer patients:

Breast cancer occurs due to abnormal cell growths in breast tissue. Although it is most often found in females, 1 out of every 100 diagnosed patients in the US is a male. Other breast cancer risk factors include, increase in age, family history or personal history of breast cancer, radiation exposure, obesity, alcohol use, among many more. Research suggests that postmenopausal hormone therapy is a risk factor due the combination of estrogen and progesterone used to treat signs and symptoms of menopause. 

Additionally, the patient's breast cancer stage is important to consider when determining the severity of the cancer and how to treat it. The American Joint Committee on Cancer (AJCC) TNM system is the most common, and contains clinical and pathologic systems. The pathologic stage is determined by examining the tissue removed during surgery, while the clinical stage is based on results of a physical exam, biopsy, and imaging tests. Nevertheless, both systems are composed of the size of the tumor, the spread to nearby lymph nodes and/or to distant sites, their estrogen and/or progesterone receptor status, the grade of the cancer, and if the cancer makes too much of HER2 protein. 

Although, most recently, breast cancer survival rates have increase and number of deaths decreased, it would be important to explore the risk factors of breast cancer. For this project, we will investigate the odds of breast cancer survival given most of the risk factors previously mentioned.


## Methods

#### Data source
  
We obtained a deidentified set containing data on 4024 breast cancer patients. this dataset contains both demographic information, such as patient age, race, and marital status; clinical information such as tumor stage, tumor size, hormone therapies (progesterone and estrogen), regional node positive, and regional node examined; and outcome information: the number of months the patient had survived prior to study conclusion, and their alive/dead status at the end of the study.

#### Data cleaning
  
We combined the regional node positive and regional node examined variables into a "regional node proportion positive" variable. This variable, but neither the node positive nor node examined variables were in the model. Further, we decided to discard the T stage and N stage variables, as they captured information already contained in the AJCC 6th stage variable. We also excluded the grade variable, as it captured the same clinical information as the differentiate variable. Due to the skewness in the distribution of the tumor size, we applied a square root transformation to that variable (**Supplemental Figure 1**). We also added a `main_stage` variable, which groups all the stages in `6th_stage` so that "IIIA" and "IIIC" are under factor level "III" for example, and added a `white` variable that tells us if the patient is "White" or not, essentially grouping "Black" and "Other" together. Both variables were created in case the reduction of factor levels makes the fit better.

```{r data import and tidying, include = FALSE}
breast_cancer <- read_csv('data/Project_2_data.csv') |> 
  janitor::clean_names() |> 
  rename(regional_node_positive = reginol_node_positive) |> 
  mutate(
    race = as_factor(race),
    marital_status = as_factor(marital_status),
    x6th_stage = as_factor(x6th_stage),
    differentiate = as_factor(differentiate),
    a_stage = as_factor(a_stage),
    root_tumor_size = sqrt(tumor_size),
    estrogen_status = as_factor(estrogen_status),
    progesterone_status = as_factor(progesterone_status),
    status = case_match(status,
                        "Dead" ~ 1,
                        "Alive" ~ 0),
    regional_prop = regional_node_positive/regional_node_examined,
    main_stage = case_when(
    str_detect(x6th_stage, "III") ~ "III",
    str_detect(x6th_stage, "II") ~ "II",
    str_detect(x6th_stage, "I") ~ "I",
    ),
    white = ifelse(race == "White", "White", "POC")) |> 
  dplyr::select(-c(regional_node_positive, regional_node_examined, survival_months,
            t_stage, n_stage, grade, tumor_size))
```


#### Model construction
  
We decided to use logistic regression model to estimate the risk of patient death within the followup window. Formally, we assumed that an for an individual, with probability *p* to die after receiving a breast cancer diagnosis, the log-odds of *p* was linear, i.e.

$logit(p_i) = \mathbf{X}\beta+ \epsilon_i$

Where ***X*** is the n x p design matrix, and $\beta$ is a vector in $\mathbb{R}^p$.

In addition to the covariates we included the interaction between `estrogen_status` and `progesterone_status` given that we found in our background research that having both "positive" increase the chances of breast cancer.

```{r construct full model, include = FALSE}
logistic_model =
  breast_cancer |> 
  glm(status ~ . + estrogen_status*progesterone_status, 
      data = _, family = binomial())
```


#### Model selection
  
We considered all We used a criterion-based method, utilizing Akaike Information Criterion (AIC) to assess the performance of our models.
<!-- ref: https://ieeexplore.ieee.org/document/1311138 -->

```{r optimize model AIC, include = FALSE}
opt_model =
  logistic_model |> 
  MASS::stepAIC(
    direction = "both",
    k = 2,
    trace = 0)

summary(opt_model)
```

#### Model validation
  
We performed 10 cross-validation to assess the performance of our model. Each observation in a dataset will be in 1 of 10 folds such that it gets used as training data 9 times, and as test data once. The predictions are then saved such that each row has an out-of-sample prediction that can be compared to the real value.

```{r cross validation, include = FALSE}
breast_cancer$cv = sample(1:10, size = nrow(breast_cancer), replace = T)

test_dfs = list(n=10)

for (i in 1:10){
  
  train = breast_cancer |>
    filter(cv != i)
  
  test = breast_cancer |>
    filter(cv == i)
  
  model = glm(status ~ age + race + marital_status + x6th_stage +
                      differentiate + estrogen_status + progesterone_status + 
                                  root_tumor_size + regional_prop, 
                      data = train, family = binomial())
  
  test_probs = predict(model, newdata = test, type="response")
  
  test_preds = ifelse(test_probs >= 0.5, 1, 0)
  
  test$pred = test_preds
  
  test_dfs[[i]] = test
  
}
```

```{r out of sample prediction, include = FALSE}
out_of_sample_preds = bind_rows(test_dfs)
```


## Results

#### Model construction and selection

We used a logistic model coupled with criterion-based stepwise regression to determine which variables were useful in predicting the risk of death in breast cancer patients. The variables that were identified as important were age, race, marital status, AJCC 6th stage, differentiate, estrogen status, progesterone status, tumor size, and regional node positive proportion. Some variables that were not identified as important by the model were whether the tumor was Stage A and the interaction between estrogen and progesterone status. For a list of model coefficients see **Supplemental Table 1**.

#### Diagnostics

This is the ROC-AUC for full model on in-sample data, which is a measure that uses the model's specificity and sensitivity to get a score bounded by 0 and 1, where 1 is best.

```{r roc curve, echo = FALSE, message = FALSE}
p = predict(opt_model,type="response")

y = breast_cancer$status

tmp = roc(y,p)
plot(tmp)
print(tmp$auc)
```

```{r brier score full model, echo=FALSE, message=FALSE}
#adding predicted prob to model
breast_cancer <- breast_cancer %>%
  mutate(predicted_prob = predict(opt_model, type = 'response'))

predicted_prob <- predict(opt_model, type = 'response')

brier_score <- mean((predicted_prob-breast_cancer$status)^2)
```

A brier score was produced to assess the optimal model's performance. Brier score measures the accuracy of probablistic predictions, where a score of 0 indicates perfect accuracy. The optimal model's brier score was `brier_score`. This suggests that our final model has good probablistic prediction accuracy. 

#### Table 1. 

This table shows the confusion matrix made from our 10 fold cross-validation, such that the predicted values are out-of-sample predictors. We can see that the model is very good at correctly predicting that somebody survived, and rarely predicts the individual died when it didn't. However, the model makes a lot of errors when trying to predict if the individual survived: more than 90% of the total error happens when the model predicts the individual died, and it actually survived. This reflects the fact that the model prefers to predict 0 as a result of the `status` variable being 0 inflated. 

```{r confusion matrix, echo = FALSE}
#rows are real values
c_matrix = table(out_of_sample_preds$status, out_of_sample_preds$pred) 
rownames(c_matrix) = c("Actually Died", "Actually Survived")
c_matrix |> 
  kable(col.names = c("Predicted Died", "Predicted Survived"))
```


Separation plots

```{r add prediction and residual, include = FALSE}
# This code chunk is probably redundant but I need it for now
breast_cancer = 
  breast_cancer |> 
  add_residuals(opt_model) |> 
  add_predictions(opt_model) |> 
  mutate(p_hat = 1/(1 + exp(-pred)))
  
```

<!-- https://www.jstor.org/stable/23025132 -->
```{r separation plot, echo = FALSE}
separationplot(pred = breast_cancer$p_hat, 
               actual = breast_cancer$status,
               newplot = F)
```

**Figure X.** Separation plot of model. Values are stripes, arranged in increasing predicted probability of death. The stripes are colored yellow if the patient survived, and red if they died. The black line indicates the predicted probability of death.

This separation plot shows that the model is able to reasonably effectively distinguish the patients that survived from those that died, though the low value of the predicted probability across the sample shows that it gives low probabilities of dying to all subjects.

#### Model performance by race

```{r aucs by race, include = FALSE}
tmp = roc(y[breast_cancer$race == "White"],p[breast_cancer$race == "White"])
white_auc = tmp$auc

tmp = roc(y[breast_cancer$race == "Black"],p[breast_cancer$race == "Black"])
black_auc = tmp$auc

tmp = roc(y[breast_cancer$race == "Other"],p[breast_cancer$race == "Other"])
other_auc = tmp$auc
```

```{r brier by race, include = FALSE}
white_breast_cancer <- breast_cancer %>%
  filter(race == 'White')
white_brier_score <- mean((white_breast_cancer$predicted_prob - white_breast_cancer$status)^2)

black_breast_cancer <- breast_cancer %>%
  filter(race == 'Black')
black_brier_score <- mean((black_breast_cancer$predicted_prob - black_breast_cancer$status)^2)

other_breast_cancer <- breast_cancer %>%
  filter(race == 'Other')
other_brier_score <- mean((other_breast_cancer$predicted_prob - other_breast_cancer$status)^2)
```


Lastly, model performance by race was explored using ROC AUC and Brier score values. The values by race are presented in the table below. 

```{r table of performance by race, echo = FALSE}
data.frame(race = c("White", "Black", "Other"),
           roc_auc = c(white_auc, black_auc, other_auc),
           brier_score = c(white_brier_score, black_brier_score, other_brier_score)) %>%
  kable(digits = 3)
```

## Discussion

We constructed a model to predict the survival of breast cancer patients, and optimized it using a criterion based-selection approach.

Our model was effective at classifying patients who survived, but performed less well at classifying patients who died when using a $\hat{p}=0.5$ as the cutoff. The separation plot we constructed suggests that a lower cutoff, such as 0.35 may be more appropriate, and further tuning may improve model performance.

## Author Contributions

## References

American Cancer Society. Breast Cancer Stages. Atlanta, GA: American Cancer Society, Inc. Available from: [https://www.cancer.org/cancer/types/breast-cancer/](https://www.cancer.org/cancer/types/breast-cancer/understanding-a-breast-cancer-diagnosis/stages-of-breast-cancer.html#:~:text=The%20earliest%20stage%20breast%20cancers,means%20cancer%20has%20spread%20more.)

Division of Cancer Prevention and Control, Centers for Disease Control and Prevention. Breast Cancer in Men. Atlanta, GA: Centers for Disease Control; 2023 July 25. Available from: [https://www.cdc.gov/cancer/breast/men/](https://www.cdc.gov/cancer/breast/men/index.htm#:~:text=Breast%20cancer%20is%20most%20often,is%20found%20in%20a%20man.&text=Invasive%20ductal%20carcinoma.,parts%20of%20the%20breast%20tissue.)

Mayo Clinic. Breast Cancer. Rochester, MN: Mayo Foundation for Medical Education and Research. Available from: [https://www.mayoclinic.org/diseases-conditions/breast-cancer](https://www.mayoclinic.org/diseases-conditions/breast-cancer/symptoms-causes/syc-20352470)

Young Survival Coalition. Breast Cancer 101. New York, NY: Young Survival Coalition. Available from: [https://youngsurvival.org/breast-cancer](https://youngsurvival.org/breast-cancer-101?gad_source=1&gclid=CjwKCAiAg9urBhB_EiwAgw88mcI-WsyaKEn-nTaWET71dtNVebk2y3qHMeLMjBnxk42z-sE5LMbPPRoCLZYQAvD_BwE)



#### Software
  
The aforementioned analyses were carried out using R 4.3.1 and RStudio Version 2023.06.2+561.
\newpage
## Appendices

a. tumor size transformation

```{r tumor size transformation hist, echo = FALSE}
tumor_plot = 
  breast_cancer |> 
  mutate(tumor_size = root_tumor_size^2) |> 
  ggplot(aes(x = tumor_size)) + 
  geom_histogram(alpha = 0.8, col = I("black")) +
  labs(
    title = "A",
    x = "Tumor size (mm)",
    y = "Frequency"
  )
  
tumor_plot_sq = 
  breast_cancer |> 
  ggplot(aes(x = root_tumor_size)) + 
  geom_histogram(alpha = 0.8, col = I("black")) +
  labs(
    title = "B",
    x = "Square root of tumor size",
    y = "Frequency"
  )

ggpubr::ggarrange(tumor_plot, tumor_plot_sq)
```
  
**Figure S1.** Transformation of tumor size variable. (A) Before transformation. (B) After square root transformation.

b. model coefficients

#### Table S1. Model Coefficients
```{r model coefficients, echo = FALSE}
opt_model |> 
  tidy() |> 
  kable(digits = 3)
```

b. ROC by race +/- sep plots?

